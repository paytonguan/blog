---
title: 网络软硬件的相关配置
categories: Router
abbrlink: Local-Network-Configuration
date: 2021-03-08 23:32:00
tags:
---

![](https://tva1.sinaimg.cn/large/008eGmZEly1gocxe06lpaj30qo0go0wp.jpg)

通过合理配置相关网络软硬件，可以实现更好的网络访问。

<!-- more -->

# 资料

```
老台机装新酒之我的第一台DIY NAS 篇二：OpenMediaVault试炼
https://post.smzdm.com/p/ar07qmdg/

变废为宝 ｜ 旧电脑变云数据中心 ｜ Esxi 配置
https://cloud.tencent.com/developer/article/1693256

给笔记本装上了VMware ESXi
https://vv1234.cn/archives/553.html

ESXI安装OpenWRT & LEDE软路由部署指南(附镜像下载)
https://blog.csdn.net/qiaohewei/article/details/108622166

完美解决单网口旧笔记本刷软路由+ap方案
https://www.right.com.cn/forum/forum.php?mod=viewthread&tid=1342500
```

# NAS

NAS即网络存储器，相当于一台具有高存储能力且能够从外部访问文件的电脑。NAS可作为家庭数据中心、资源共享中心等。

NAS系统可选择群晖和威联通。

# 路由器

路由器可分为软路由和硬路由。硬路由即家用的普通路由器，部分可以刷第三方固件。软路由更偏向于提供Wifi功能的电脑。

## 第三方固件

常见的固件有OpenWrt（与LEDE已合并）、潘多拉、华硕、梅林、老毛子等。这些第三方固件可以安装翻墙插件。

部分固件下载链接如下。

```
https://openwrt.club/dl
```

### 原版OpenWrt

OpenWrt本身未带任何UI，需要通过LuCI、webif等插件延伸界面。LuCI是OpenWrt使用率最高的Web管理界面。

```
# 小米Redmi AC2100刷openwrt
https://openwrt.org/toh/xiaomi/xiaomi_redmi_router_ac2100
```

#### 下载

若安装在旧笔记本上，则选择X86或X64架构，下载名字带有squashfs的安装包。

```
https://downloads.openwrt.org/releases/19.07.7/targets/x86/64/
```

#### 软件包

进入管理后台后，点击系统-软件包，即可安装软件包。

若安装时内核不符合要求，则记录该软件包所需要的内核版本。打开以下链接并搜索`kernel`，找到内核安装包。

```
https://downloads.openwrt.org/snapshots/targets/x86/64/packages/
```

复制内核安装包的下载地址，在OpenWrt终端中执行以下命令，安装并重启即可。

```
# wget后面是下载地址
wget https://downloads.openwrt.org/snapshots/targets/x86/64/packages/kernel_5.4.65-1-2b15fbe2fc4637fac17bbc326e475cff_x86_64.ipk

cd /root

# 后面是下载好的ipk文件名
opkg install kernel_5.4.65-1-2b15fbe2fc4637fac17bbc326e475cff_x86_64.ipk
reboot
```

##### 热点分享

在软件包界面搜索无线网卡驱动，注意需要安装对应的配置界面。如本机无线网卡型号为Intel(R) PRO/Wireless 3945ABG，则需要安装驱动kmod-iwl3945和配置界面luci-app-wifischedule。另还需安装hostapd。

### Koolshare OpenWrt

#### 下载

默认密码为koolshare。

若安装在旧笔记本上，则选择`虚拟机转盘或PE下写盘专用`，下载后缀为`squashfs.img.gz`的安装包即可。也可下载根目录下的安装包，经验证无明显差别。

```
http://firmware.koolshare.cn/LEDE_X64_fw867/
```

#### 软件中心

在管理页面点击左侧的`酷软`即可进入软件中心，点击离线安装可上传本地插件安装包。需要用tomato主题才可正常使用酷软中心。

##### 翻墙插件

如果提示检测到离线安装包名有非法关键词，则开启路由器的SSH功能，登录并输入以下命令后，再进行离线安装即可。

```
sed -i 's/\tdetect_package/\t# detect_package/g' /koolshare/scripts/ks_tar_install.sh
```

###### Koolclash

打开以下链接下载安装包，通过离线安装上传即可。

```
https://github.com/SukkaW/Koolshare-Clash/releases/
```

教程如下。

```
https://koolclash.js.org/#/
```

###### 其它

下载链接如下。通过离线安装上传即可。

```
https://github.com/hq450/fancyss_history_package/tree/master/fancyss_X64
```

### eSir OpenWrt

分为高大全和精品小包，其中高大全有更多功能。

#### 下载

管理IP为192.168.5.1，密码为password。

若安装在旧笔记本上，则选择X86或X64架构，下载名字带有squashfs的安装包。

```
https://drive.google.com/drive/folders/1uRXg_krKHPrQneI3F2GNcSVRoCgkqESr
```

### 自行编译OpenWrt

#### 环境配置

编译固件需要在Linux下进行。打开终端并输入以下命令。

```
sudo apt install git binutils patch bzip2 flex bison make autoconf gettext texinfo unzip sharutils subversion libncurses5-dev ncurses-term zlib1g-dev asciidoc libz-dev libssl-dev
```

根据路由器所运行的OpenWrt版本下载源码，以原版OpenWrt 18.06.1为例，示例如下。

```
git clone https://git.openwrt.org/openwrt/openwrt.git
cd openwrt
git checkout v18.06.1
```

也可使用LEDE版本，如下。

```
git clone https://github.com/coolsnowwolf/lede
cd lede
```

#### 加入扩展包

若需要加入新的功能，则需要克隆到源码目录。首先运行以下命令以更新feed。

```
./scripts/feeds update -a
./scripts/feeds install -a
```

然后即可安装拓展包。以加入修改NAT内心的NAT扩展包openwrt-fullcone为例，命令如下。

```
git clone -b master --single-branch https://github.com/LGA1150/openwrt-fullconenat package/fullconenat
```

#### 进行编译

终端输入以下命令即可出现编译选项界面。

```
make menuconfig
```

需要修改的内容如下。对于openwrt-fullcone，需要跳转到Network-Firewall，选中iptables_mod_fullconenat，按下M键以作为模块编译。

|      选项      |                   内容                  |
|----------------|-----------------------------------------|
| Target System  | 选择路由器架构                          |
| Subtarget      | 选择路由器主板型号                      |
| Target Profile | 选择路由器型号，无则选择Default Profile |

保存配置后输入以下命令即可开始编译。

```
make V=s
```

#### 插件配置

将打包好的固件刷入路由器后，openwrt-fullcone需要通过以下命令以实现切换NAT类型。若完成后发现还是Symmetric NAT且确定运营商不是Symmetric NAT，则需在防火墙的WAN Zone配置中将Input设置为reject。

```
modprobe xt_FULLCONENAT
echo "xt_FULLCONENAT" >> /etc/modules.d/ipt-nat
echo "iptables -t nat -A zone_wan_prerouting -j FULLCONENAT" >> /etc/firewall.user
echo "iptables -t nat -A zone_wan_postrouting -j FULLCONENAT" >> /etc/firewall.user
/etc/init.d/firewall restart
sleep 70 && reboot  # 重启路由器
```

## 家庭组网

### 连线逻辑

入户光纤连接到光猫上，光猫将光信号转换为电信号。光猫可以直接连接到电脑上，也可以连接一个或多个路由器。路由器可以连接电脑，也可以再连接路由器。

一般连接外网的线需要接入到WAN口，连接内网的线需要接入到LAN口。

对于家庭宽带，ISP会给一个账号，通过该账号拨号上网即可连接。

```
─── 入户光纤
     └── 光猫
          ├── 电脑
          ├── 路由器A
          │    ├── 电脑
          │    └── ...
          ├── 路由器B
          │    ├── 电脑
          │    ├── 路由器C
          │    │    ├── 电脑
          │    │    └── ...
          │    └── ...
          └── ...
```

### 多路由器

为扩大网络覆盖范围，可通过增加路由器的方式实现信号增强。路由器可以不同方式进行连接。

#### 并联

此处特指在光猫上并联，如路由器A和路由器B。

光猫一般有桥接模式和路由模式。桥接模式下光猫不负责拨号，由下属设备负责，一般为路由器。路由模式下光猫负责拨号，下属设备无需再次拨号。

路由器并联时，光猫一般需要设置为路由模式，使光猫负责拨号，两个路由器无需再次拨号。若光猫设置为桥接模式，则两个路由器需要分别拨号，但由于一般情况下一个账号只允许一条线拨号，两个路由器中将只有一个拨号成功。若账号允许多条线拨号，或ISP提供了多个账号，则可使用桥接模式。

在ISP配置家庭宽带时，一般将光猫设置为桥接模式，将路由器设置为拨号上网。更改光猫为路由模式，路由器为自动获取IP地址，即可完成多路由器的并联。

路由模式需要在光猫的管理后台开启，且需要超级管理员账号。将光猫的LAN口和电脑直接连接，查看光猫背面标注的管理后台地址，对于电信光猫为192.168.1.1。

在浏览器输入以上地址访问后台，并以以下超级管理员账号登录。

|   ISP    |    用户名    |     密码     |
|----------|--------------|--------------|
| 中国电信 | telecomadmin | nE7jA%5m     |
| 中国移动 | CMCCAdmin    | aDm8H%MdA    |
| 中国联通 | CUAdmin      | CUAdmin      |
| 华为原版 | telecomadmin | admintelecom |
| telnet   | root         | admin        |

进入后台后点击网络-网络设置，连接名称选择`3_INTERNET_B_VID_41`，连接模式改为路由，用户名和密码为ISP提供的拨号账号，保存即可完成光猫模式修改。

断开光猫和电脑的连接，并将路由器的LAN口与电脑连接。进入路由器后台并修改模式为自动获取IP地址即可。

#### 串联

即为将路由器连接到路由器，如路由器B和路由器C。光猫和路由器B不需要修改任何配置，路由器C设置为自动获取IP地址即可。

### 旁路由

#### 连线逻辑

旁路由即旁路网关，是挂靠在主路由网络下的一个旁系网络，分担一部分路由器的功能。旁路由的连线如下。

旁路由可用旧笔记本改造而来。由于笔记本只有一个千兆网口，该口需与路由器的LAN口连接，因此旁路由无法像正常路由器一样提供LAN口，只能挂靠在主路由下。

```
─── 入户光纤
     └── 光猫
          └── 路由器
               ├── 电脑
               ├── 旁路由
               └── ...
```

#### 笔记本改造

该笔记本需有一个网口。此处以Koolshare OpenWrt为例说明使用方法，其它固件也适用。

将该笔记本按照上述连线方式进行连接。下载好Koolshare OpenWrt固件后解压，下载IMG写盘工具Roadkils DiskImage，链接如下。

```
http://www.pc6.com/softview/SoftView_691680.html
```

准备好PE环境并进入，通过DiskGenius清除要安装固件的磁盘的所有分区，以避免后续出现sector错误。打开IMG写盘工具，驱动器从physical层面选，映像档选择固件，开始写入。

写入完成后重启，并启动到写入固件的磁盘上。按回车进入主界面，然后输入以下命令。

```
vim etc/config/network
```

切换到`option interface 'lan'`下的`option ipaddr '192.168.1.1'`，按下I键进入编辑模式。

此处需要将192.168.1.1修改为其它地址，其中前三位需与主路由器管理后台地址，即主路由器网关一致。可通过查阅路由器说明书或在Mac下通过网络偏好设置-高级-TCP/IP下的路由器一栏得到。

如主路由器管理后台为192.168.31.1，则需要将此处改为192.168.31.X，其中X是除0和1以外合法的IP地址数字，此处设置为192.168.31.2。

完成修改后按ESC键，输入`:wq`保存，然后输入`reboot`重启。

打开通过Wifi或网线连接到主路由器的另一台电脑，在浏览器输入刚才修改好的地址即可进入该旁路由管理页面，此处为192.168.31.2。进入后点击网络-接口-LAN-修改，相关设置填写方法如下。

|          选项         |     内容     |     示例     |
|-----------------------|--------------|--------------|
| IPv4地址              | 旁路由网关   | 192.168.31.2 |
| IPv4网关              | 主路由器网关 | 192.168.31.1 |
| 使用自定义的DNS服务器 | 主路由器网关 | 192.168.31.1 |

点击物理设置，取消勾选桥接接口，接口选择`"eth0"(lan)`。保存后在30秒内登入IPv4地址中的地址以确认更改。

点击防火墙-自定义规则，添加以下规则。

```
iptables -t nat -I POSTROUTING -o eth0 -j MASQUERADE
```

点击网络-接口-LAN-修改-DHCP服务器，进行DHCP配置修改。对于不同的主路由器，修改方法可能不同。

以小米路由器为例，为确保不修改主路由器配置，主路由器的DHCP为开启状态。则此时应将旁路由配置为开启DHCP，但不使用强制DHCP。在基本设置中取消勾选忽略此接口，在高级设置中取消勾选强制，保存即可。

在需要使用旁路由的终端上，需要手动配置IP和DNS，内容如下。

|       选项       |            内容           |      示例     |
|------------------|---------------------------|---------------|
| IP地址           | 自动获取IP时得到的地址    | 192.168.31.72 |
| 子网掩码         | 前三个数字不变，故为24个1 | 255.255.255.0 |
| 路由器（IP网关） | 旁路由的IP地址            | 192.168.31.2  |
| DNS              | 旁路由的IP地址            | 192.168.31.2  |

配置完成后终端即可通过旁路由连接上网。可以通过相关固件设置实现广告过滤、翻墙等功能。

# 参考教程

## 家庭组网填坑指南-旁路由

```
https://www.bilibili.com/read/cv6354709/
```

## 如何获取光猫超级密码，获取后都能干什么，教你一招必获取

```
http://www.360doc.com/content/20/1030/13/17064127_943196963.shtml
```

## 天翼网关3.0改桥接模式，即改为光猫模式

```
https://zhuanlan.zhihu.com/p/293047060
```

## hq450/fancyss

```
https://github.com/hq450/fancyss
```

## 单口闲置笔记本/PC/小主机/工控机改造软路由【入门级】体验教程

```
https://zhuanlan.zhihu.com/p/146632293
```

## 软路由的介绍及安装和配置

```
https://blog.csdn.net/jenrey/article/details/105775024
```

## 解决openwrt opkg内核版本不匹配问题

```
https://blog.csdn.net/qq_29974161/article/details/108573994
```

## 小米路由器+ 旁路由设置教程 跑满500M

```
https://www.right.com.cn/forum/thread-3615208-1-1.html
```

## OPENWRT-KOOLSHARE软路由，一级/单臂/二级/旁软路由设置单臂路由联网教程

```
https://zhuanlan.zhihu.com/p/146961683
```

## 从听说到上手，人人都能看懂的旁路由入门指南

```
https://sspai.com/post/59708
```

## OpenWRT 包的编译以及更改 NAT 类型

```
https://blog.qwq.ren/posts/compile-openwrt-package-and-switch-nat-type/
```

## 入门NAS？一篇就够了！真正给小白看的NAS科普篇——NAS是什么？你真的需要NAS吗？

```
https://post.smzdm.com/p/a4wmxw98/
```
